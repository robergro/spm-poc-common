name: build-and-test
on:
  workflow_call
    
env:
  spm_path: ${{ vars.SPM_PATH && '/' || '' }}
  spm_name: ${{ vars.SPM_NAME }}-Package
  swift_version: '5.9'
  xcode_path: "/Applications/Xcode_15.0.1.app"
  xcodebuild_sdk: -sdk iphonesimulator
  xcodebuild_derivedData: ".spmComponentDerivedData/"
  xcodebuild_destination: -destination 'platform=iOS Simulator,name=iPhone 15 pro'

jobs:
  test:
    name: Unit and Snapshot Test
    runs-on: macos-14
    steps:
    - name: "Package name"
      run: echo "Build ${{ env.spm_name }} SPM at ${{ github.workspace }}"
    - name: Set Swift Version
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: ${{ env.swift_version }}
    - name: Get swift version
      run: swift --version
    - name: Select Xcode
      run: sudo xcode-select -s ${{ env.xcode_path }}
    - name: Checkout Action
      uses: actions/checkout@v4
    - name: Get sourcery
      run: |
        brew install sourcery
    - name: Run sourcery
      run: |
        xcodebuild -scheme ${{ vars.SPM_NAME }} -derivedDataPath ${{ env.xcodebuild_derivedData }} ${{ env.xcodebuild_destination }}
        echo "LOGROB Start Loop"
        for file in $( find . -type f -name ".sourcery.yml" -exec dirname {} \; )
        do
          echo "LOGROB Iteration"
          pwd
          echo "LOGROB --0"
          ls -a
          echo "LOGROB --1"
          cd ${{ github.workspace }}
          echo "LOGROB folder"
          echo $file
          echo "LOGROB folder dirname"
          dirname "$file"
          echo "LOGROB --2"
          cd "$file"
          echo "LOGROB file"
          ls -a
          sourcery
        done
        echo "LOGROB End loop"